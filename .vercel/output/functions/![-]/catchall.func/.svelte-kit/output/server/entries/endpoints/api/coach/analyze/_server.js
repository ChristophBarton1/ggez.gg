import{json as e}from"@sveltejs/kit";async function a({request:a}){try{const{matches:t,summonerInfo:s}=await a.json();if(!t||0===t.length)return e({error:"No matches provided"},{status:400});const i=function(e,a){const t={totalGames:e.length,wins:0,losses:0,kills:[],deaths:[],assists:[],cs:[],visionScore:[],gameDuration:[],goldPerMinute:[],damagePerMinute:[],lateGamePerformance:{wins:0,games:0},championPool:{},rolePerformance:{}};e.forEach(e=>{const s=e.info.participants.find(e=>e.puuid===a.puuid);if(!s)return;const i=s.win;t.wins+=i?1:0,t.losses+=i?0:1,t.kills.push(s.kills),t.deaths.push(s.deaths),t.assists.push(s.assists),t.cs.push(s.totalMinionsKilled+s.neutralMinionsKilled),t.visionScore.push(s.visionScore);const o=e.info.gameDuration/60;t.gameDuration.push(o),t.goldPerMinute.push(s.goldEarned/o),t.damagePerMinute.push(s.totalDamageDealtToChampions/o);const n=s.championName;t.championPool[n]||(t.championPool[n]={games:0,wins:0}),t.championPool[n].games++,i&&t.championPool[n].wins++,o>30&&(t.lateGamePerformance.games++,i&&t.lateGamePerformance.wins++);const r=s.teamPosition||"UNKNOWN";t.rolePerformance[r]||(t.rolePerformance[r]={games:0,wins:0}),t.rolePerformance[r].games++,i&&t.rolePerformance[r].wins++});const s=e=>e.reduce((e,a)=>e+a,0)/e.length;return{winRate:(t.wins/t.totalGames*100).toFixed(1),totalGames:t.totalGames,wins:t.wins,losses:t.losses,avgKills:s(t.kills).toFixed(1),avgDeaths:s(t.deaths).toFixed(1),avgAssists:s(t.assists).toFixed(1),kda:((s(t.kills)+s(t.assists))/Math.max(s(t.deaths),1)).toFixed(2),avgCS:s(t.cs).toFixed(0),avgVisionScore:s(t.visionScore).toFixed(1),avgGameDuration:s(t.gameDuration).toFixed(1),avgGoldPerMin:s(t.goldPerMinute).toFixed(0),avgDamagePerMin:s(t.damagePerMinute).toFixed(0),lateGameWinRate:t.lateGamePerformance.games>0?(t.lateGamePerformance.wins/t.lateGamePerformance.games*100).toFixed(1):0,championPool:t.championPool,rolePerformance:t.rolePerformance}}(t,s),o=await async function(e){const a=[];parseFloat(e.avgDeaths)>6&&a.push({category:"Survival",severity:"high",title:"Too Many Deaths",description:`You're dying ${e.avgDeaths} times per game. Focus on positioning and map awareness.`,tip:'Before engaging, ask yourself: "Where is their team?" Play safer when you don\'t have vision.',impact:"Reducing deaths by 2 per game can increase your winrate by 10-15%!"}),parseFloat(e.avgVisionScore)<20&&a.push({category:"Vision",severity:"medium",title:"Low Vision Score",description:`Your vision score (${e.avgVisionScore}) is below average.`,tip:"Buy more Control Wards and place wards in key locations: Dragon pit, Baron pit, river brushes.",impact:"Better vision = Better decisions = More wins!"});const t=parseFloat(e.avgCS)/parseFloat(e.avgGameDuration);t<5.5&&a.push({category:"Farming",severity:"medium",title:"CS Could Be Better",description:`You're averaging ${t.toFixed(1)} CS/min. Aim for 6-7 CS/min.`,tip:"Practice last-hitting in Practice Tool. Every 15 CS = 1 kill in gold!",impact:"Improving CS by 20% gives you significant gold advantage."}),e.lateGameWinRate<e.winRate-10&&a.push({category:"Late Game",severity:"medium",title:"Weak Late Game",description:`Your late game winrate (${e.lateGameWinRate}%) is lower than your overall winrate.`,tip:"Focus on objectives in late game. One Baron = Win. Don't throw by getting caught!",impact:"Better late game decisions can win you games you're ahead in."});const s=Object.entries(e.championPool).filter(([e,a])=>a.games>=3).sort((e,a)=>a[1].wins/a[1].games-e[1].wins/e[1].games)[0];if(s){const[t,i]=s,o=(i.wins/i.games*100).toFixed(1);o>parseFloat(e.winRate)+10&&a.push({category:"Champion Pool",severity:"low",title:`${t} Is Your Best Pick!`,description:`You have ${o}% winrate on ${t} (${i.games} games).`,tip:`One-trick ${t} to climb faster! You clearly understand this champion.`,impact:"Playing your best champions more often = Faster climbing!"})}const i={overall:parseFloat(e.winRate)>=55?"Excellent":parseFloat(e.winRate)>=50?"Good":parseFloat(e.winRate)>=45?"Needs Improvement":"Focus Required",strengths:[],improvements:[]};return parseFloat(e.avgDeaths)<4&&i.strengths.push("Great survival instinct"),parseFloat(e.avgVisionScore)>30&&i.strengths.push("Excellent vision control"),t>6.5&&i.strengths.push("Strong farming"),parseFloat(e.lateGameWinRate)>60&&i.strengths.push("Late game master"),parseFloat(e.avgDeaths)>6&&i.improvements.push("Reduce deaths"),parseFloat(e.avgVisionScore)<20&&i.improvements.push("Improve vision score"),t<5.5&&i.improvements.push("Farm more efficiently"),{insights:a,summary:i,stats:e}}(i);return e({success:!0,analysis:{stats:i,coaching:o,timestamp:(new Date).toISOString()}})}catch(t){return e({error:"Failed to generate coaching insights",details:t.message},{status:500})}}export{a as POST};
