import e from"sharp";const t=new Map;async function a({url:a}){try{const n=a.searchParams.get("url"),r=parseInt(a.searchParams.get("w"))||null,s=a.searchParams.get("format")||"webp";if(!n)return new Response("Missing url parameter",{status:400});const o=decodeURIComponent(n),i=`${o}_${r}_${s}`;if(t.has(i)){const e=t.get(i);return new Response(e.buffer,{headers:{"Content-Type":e.contentType,"Cache-Control":"public, max-age=31536000, immutable","X-Cache":"HIT"}})}const f=await fetch(o);if(!f.ok)return new Response("Image not found",{status:404});const u=await f.arrayBuffer(),c=Buffer.from(u);let p=e(c);r&&(p=p.resize(r,null,{fit:"inside",withoutEnlargement:!0})),p="webp"===s?p.webp({quality:80,effort:4}):"avif"===s?p.avif({quality:80,effort:4}):p.png({quality:80,compressionLevel:9});const l=await p.toBuffer();if(t.size>100){const e=t.keys().next().value;t.delete(e)}const m="webp"===s?"image/webp":"avif"===s?"image/avif":"image/png";return t.set(i,{buffer:l,contentType:m}),new Response(l,{headers:{"Content-Type":m,"Cache-Control":"public, max-age=31536000, immutable","X-Cache":"MISS"}})}catch(n){return new Response("Internal server error",{status:500})}}export{a as GET};
